<script>
  function determine_team_name_text(team_row) {
    text = "<a href='/team/" + team_row.id + "'>" + team_row.name + "</a>"
    {% if team is not None %}
      if(team_row.name == "{{ team.name }}" ) {
        text = team_row.name
      }
    {% endif %}
    return text;
  }
  function blur_button_click(game_id) {
    var blur_elements = document.getElementsByClassName("blur-content" + game_id);
    var i;
    var j;
    var blur_buttons = document.getElementsByClassName("blur-button" + game_id);
    for (i = 0; i < blur_buttons.length; i++) {
      ele = blur_buttons[i];
      if (ele.classList.contains("blur")){
        ele.innerHTML = "Reveal All";
        ele.classList.remove("blur");
        ele.classList.add("reveal");
        for (j = 0; j < blur_elements.length; j++) {
          blur_element = blur_elements[j]
          if (!blur_element.classList.contains("blurred-content")){
            blur_element.classList.add("blurred-content");
            var mask_container = $(blur_element).closest('.mask_character_length')
            if (mask_container.length){
              $(blur_element).children('.mask_character_output').html('BLANK');
            }
          }
        }
      }
      else {
        ele.innerHTML = "Blur All"
        ele.classList.remove("reveal");
        ele.classList.add("blur");
        for (j = 0; j < blur_elements.length; j++) {
          blur_element = blur_elements[j]
          if (blur_element.classList.contains("blurred-content")){
            blur_element.classList.remove("blurred-content");
            var mask_container = $(blur_element).closest('.mask_character_length')
            if (mask_container.length){
              $(blur_element).children('.mask_character_output').html($(blur_element).children('.mask_character_original_value').html());
            }
          }
        }
      }
    }
  }

  $(document).ready( function () {
    $('#game-list-new').on( 'init.dt', function () {
      // Datatable done loading...
      $('.blurred-content').click(function() {
        if (this.classList.contains("blurred-content")){
            this.classList.remove("blurred-content");
            var mask_container = $(this).closest('.mask_character_length')
            if (mask_container.length){
              $(this).children('.mask_character_output').html($(this).children('.mask_character_original_value').html());
            }
        } else {
          this.classList.add("blurred-content");
          $(this).find('.mask_character_output').html('BLANK');
        }
      })

      $('.mask_character_length').each(function(){
        if (this.classList.contains("blurred-content")){
          $(this).find('.mask_character_output').html('BLANK');
        }
      })
    }).DataTable({
      "language": {
        "emptyTable": "No games have been played."
      },
      "order": [[2, 'desc']],
      "autoWidth": false,
      "bFilter": false,
      "bInfo": false,
      "bLengthChange": false,
      "bPaginate": true,
      "deferRender": true,

      "processing": true,
      "ajax": {
        {% if team is None %}
        "url": '/api/completed_games',
        {% else %}
        "url": '/api/completed_games/{{ team.id }}',
        {% endif %}
        "dataSrc": 'data'
      },
      "columns": [
        { data: 'home_team["name"]' },
        { data: 'away_team["name"]' },
        { data: 'start_time'},
        { data: 'interest_level'},
        { data: 'date_from_start_time'},
      ],

      {% if request.path == '/' %}
      "iDisplayLength": 15,
      {% else %}
      "iDisplayLength": 10,
      {% endif %}

      "fnDrawCallback": function() {
        $("#game-list-new-header").remove();
      },
      "columnDefs": [
        {
          // home team
          "targets": [0],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            $(td).width("30%").css("text-align", "right");
            text = determine_team_name_text(rowData.home_team)
            $(td).html(text);
          }
        },
        {
          // away team
          "targets": [1],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            $(td).width("30%").css("text-align", "left");
            text = determine_team_name_text(rowData.away_team)
            $(td).html(text);
          }
        },
        {
          // start time
          "targets": [2],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            var start_time = new Date(cellData*1000);
            var locale = document.querySelector('html').getAttribute('lang')
            var options = {
              weekday: "short",
              month: "2-digit",
              day: "numeric",
            };
            $(td).width("20%").css("text-align", "center");
            $(td).html(start_time.toLocaleTimeString());
          }
        },
        {
          // severity badge
          "targets": [3],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            $(td).width("20%").css("text-align", "center");

            // interest score/label
            if (rowData.interest_level == 'High'){
              severity_text = "High"
              severity_label = "success"
            }
            else if (rowData.interest_level == 'Medium'){
              severity_text = 'Medium'
              severity_label = 'warning'
            }
            else {
              severity_text = 'Low'
              severity_label = 'danger'
            }

            // local time
            var start_time = new Date(rowData.start_time * 1000);
            var locale = document.querySelector('html').getAttribute('lang')
            var options = {
              weekday: "short",
              month: "2-digit",
              day: "numeric",
              year: "numeric",
            };
            formatted_start_time = start_time.toLocaleDateString(locale, options) + " " + start_time.toLocaleTimeString()

            // questions
            var questions_body = "<tbody>"
            for (let i in rowData.questions) {
              question = rowData.questions[i]
              if (question.answer == 'Yes'){
                question_value_output = '<span class="glyphicon glyphicon-thumbs-up" id="question-answer-thumbs-up"></span>'
              }
              else if (question.answer == 'No'){
                question_value_output = '<span class="glyphicon glyphicon-thumbs-down" id="question-answer-thumbs-down"></span>'
              }
              else {
                question_value_output = question.answer
              }
              questions_body += `
                <tr class="questions-table-row">
                  <td width="70%"><div>${ question.description }</div></td>
                  <td width="30%">
                    <div class="blur-content blurred-content blur-content${ rowData.id } mask_character_length">
                      <span class="mask_character_output"></span>
                      <span class="mask_character_original_value">${ question_value_output }</span>
                    </div>
                  </td>
                </tr>
              `
            }
            questions_body += "</tbody>"


            // score modifications
            var score_modifications_body = "<tbody>"
            for (let i in rowData.score_modifications) {
              score_modification = rowData.score_modifications[i]
              score_modifications_body += `
              <tr class="score-modifications-table-row">
                <td><div class="blur-content blurred-content blur-content${ rowData.id }">${ score_modification.value }</div></td>
                <td><div class="blur-content blurred-content blur-content${ rowData.id }">${ score_modification.priority }</div></td>
                <td><div class="blur-content blurred-content blur-content${ rowData.id }">${ score_modification.reason }</div></td>
              </tr>
              `
            }
            score_modifications_body += "</tbody>"


            var div_modal = `
              <div class="modal fade" id="gameModal${ rowData.id }" tabindex="-1" role="dialog">
                <div class="modal-dialog" role="document">
                  <div class="modal-content">
                    <div class="modal-header" id="game-info">
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                      <h3 class="modal-title">
                        <img src="${ rowData.home_team.logo }" alt="" id="team-logo-game-left" width="50px" height="50px" />${ rowData.home_team.name } - ${ rowData.away_team.name }<img src="${ rowData.away_team.logo }" alt="" id="team-logo-game-right" width="50px" height="50px" />
                      </h3>
                      <div class="row">
                        <div id="game-modal-left">
                          <div class="blur-content blurred-content blur-content${ rowData.id }"><h2>${ rowData.home_team.score }</h2></div>
                        </div>
                        <div id="game-modal-middle">
                          <div class="game-info last_updated_timestamp">${ formatted_start_time }</div>
                          <div class="game-info">${ rowData.stadium }, ${ rowData.city }</div>
                          <div class="game-info">Referee: ${ rowData.referee }</div>
                          <div class="row">
                            <div>
                              <h4><span class="label label-${ severity_label } blur-content blurred-content blur-content${ rowData.id }">${ severity_text}</span></h4>
                            </div>
                            <div class="blur-content blurred-content blur-content${ rowData.id }">(${ rowData.interest_score } / 100)</div>
                          </div>
                        </div>
                        <div id="game-modal-right">
                          <div class="blur-content blurred-content blur-content${ rowData.id }"><h2>${ rowData.away_team.score }</h2></div>
                        </div>
                      </div>
                    </div>
                    <div class="modal-body">
                      <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#game-${ rowData.id }-questions">Questions</a></li>
                        <li><a data-toggle="tab" href="#game-${ rowData.id }-score-modifications">Score Modifications</a></li>
                        <li><a data-toggle="tab" href="#game-${ rowData.id }-highlights">Highlights</a></li>
                      </ul>

                      <div class="tab-content">
                        <div id="game-${ rowData.id }-questions" class="tab-pane fade in active">
                          <table class="table table-striped table-bordered table-compact" id="game-questions-table">
                            <thead>
                              <th>Question</th>
                              <th>Answer</th>
                            </thead>
                            ${ questions_body }
                          </table>
                        </div>
                        <div id="game-${ rowData.id }-score-modifications" class="tab-pane fade">
                          <table class="table table-striped table-bordered table-compact" id="game-score-modifications-table">
                            <thead>
                              <th>Points</th>
                              <th>Priority</th>
                              <th>Description</th>
                            </thead>
                            ${ score_modifications_body }
                          </table>
                        </div>
                        <div id="game-${ rowData.id }-highlights" class="tab-pane fade">
                          <iframe width="450" height="350" src="${ rowData.highlights_url }" frameborder="0" allowfullscreen></iframe>
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                      <button class="blur-button blur-button${ rowData.id } reveal btn btn-primary" id="blur-toggle-button" onclick="blur_button_click(${ rowData.id })">Reveal All
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="info-icon">
                <a href="#gameModal${ rowData.id }" data-toggle="modal">
                  <span class="glyphicon glyphicon-info-sign"></span>
                </a>
              </div>
            `;

            $(td).html(div_modal);
          }
        },
        {
          // date_from_start_time
          "aTargets": [4],
          "bVisible": false,
        }
      ],
      "rowGroup": {
        "dataSrc": function (row) {
          return row.date_from_start_time;
        }
      }
    });

    $('#game-list-upcoming').DataTable({
      "language": {
        "emptyTable": "No upcoming games available."
      },
      "order": [[2, 'asc']],
      "ordering": false,
      "autoWidth": false,
      "bFilter": false,
      "bInfo": false,
      "bLengthChange": false,
      "bPaginate": true,
      "deferRender": true,
      "processing": true,
      "ajax": {
        {% if team is None %}
        "url": '/api/upcoming_games',
        {% else %}
        "url": '/api/upcoming_games/{{ team.id }}',
        {% endif %}
        "dataSrc": 'data'
      },
      "columns": [
        { data: 'home_team["name"]' },
        { data: 'away_team["name"]' },
        { data: 'start_time'},
        { data: 'date_from_start_time'},
      ],
      {% if request.path == '/' %}
      "iDisplayLength": 15,
      {% else %}
      "iDisplayLength": 10,
      {% endif %}
      "fnDrawCallback": function() {
        $("#game-list-upcoming-header").remove();
      },
      "columnDefs": [
        {
          // home team
          "targets": [0],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            $(td).width("30%").css("text-align", "right");
            text = determine_team_name_text(rowData.home_team)
            $(td).html(text);
          }
        },
        {
          // away team
          "targets": [1],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            $(td).width("30%").css("text-align", "left");
            text = determine_team_name_text(rowData.away_team)
            $(td).html(text);
          }
        },
        {
          // start time
          "targets": [2],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            var start_time = new Date(cellData*1000);
            var locale = document.querySelector('html').getAttribute('lang');
            var options = {
              weekday: "short",
              month: "2-digit",
              day: "numeric",
            };
            $(td).width("20%").css("text-align", "center");
            $(td).html(start_time.toLocaleTimeString());
          }
        },
        {
          // date_from_start_time
          "bVisible": false,
          "aTargets": [3]
        }
      ],
      "rowGroup": {
        "dataSrc": function (row) {
          return row.date_from_start_time;
        }
      }
    });

  });
</script>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#completed-games">Completed Games</a></li>
  <li><a data-toggle="tab" href="#upcoming-games">Upcoming Games</a></li>
</ul>

<div class="tab-content">
  <div id="completed-games" class="tab-pane fade in active">
    <table id="game-list-new" class="table table-striped table-bordered table-compact">
      <thead id="game-list-new-header"/>
      <thead/>
    </table>
  </div>
  <div id="upcoming-games" class="tab-pane fade">
    <table id="game-list-upcoming" class="table table-striped table-bordered table-compact">
      <thead id="game-list-upcoming-header"/>
      <thead/>
    </table>
  </div>
</div>
