<script>
  function blur_button_click(game_id) {
    var blur_elements = document.getElementsByClassName("blur-content" + game_id);
    var i;
    for (i = 0; i < blur_elements.length; i++) {
      ele = blur_elements[i]
      if (ele.classList.contains("blurred-content")){
          ele.classList.remove("blurred-content");
      } else {
        ele.classList.add("blurred-content");
      }
    }
    var blur_buttons = document.getElementsByClassName("blur-button" + game_id);
    for (i = 0; i < blur_buttons.length; i++) {
      ele = blur_buttons[i];
      if (ele.classList.contains("blur")){
        ele.innerHTML = "Reveal";
        ele.classList.remove("blur");
        ele.classList.add("reveal");
      }
      else {
        ele.innerHTML = "Blur"
        ele.classList.remove("reveal");
        ele.classList.add("blur");
      }
    }
  }

  window.onload = function(){
    $('#last_updated_timestamp').each(function(){
      var start_time = new Date($(this).html()*1000);
      var locale = document.querySelector('html').getAttribute('lang')
      var options = {
        weekday: "short",
        month: "2-digit",
        day: "numeric",
      };
      $(this).html(start_time.toLocaleDateString(locale, options) + " " + start_time.toLocaleTimeString())
    })
  };

  $(document).ready( function () {
    $('#game-list-new').DataTable({
      "order": [[2, 'desc']],
      "autoWidth": false,
      "bFilter": false,
      "bInfo": false,
      "bLengthChange": false,
      "bPaginate": true,

      {% if request.path == '/' %}
      "iDisplayLength": 17,
      {% else %}
      "iDisplayLength": 10,
      {% endif %}

      "fnDrawCallback": function() {
        $("#game-list-new-header").remove();
      },
      "columnDefs": [
        {
          "targets": [0,1,2,3],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            if (col == 2){
              var start_time = new Date(cellData*1000);
              var locale = document.querySelector('html').getAttribute('lang')
              var options = {
                weekday: "short",
                month: "2-digit",
                day: "numeric",
              };
              $(td).html(start_time.toLocaleTimeString())
            }
          }
        },
        {
          "bVisible": false,
          "aTargets": [4]
        }
      ],
      "rowGroup": {
        "dataSrc": 4
      },
    });
    $('#game-list-upcoming').DataTable({
      "order": [[2, 'asc']],
      "ordering": false,
      "autoWidth": false,
      "bFilter": false,
      "bInfo": false,
      "bLengthChange": false,
      "bPaginate": false,

      "fnDrawCallback": function() {
        $("#game-list-upcoming-header").remove();
      },
      "columnDefs": [
        {
          "targets": [0,1,2,3],
          "bSortable": false,
          "createdCell": function (td, cellData, rowData, row, col) {
            if (col == 2){
              var start_time = new Date(cellData*1000);
              var locale = document.querySelector('html').getAttribute('lang')
              var options = {
                weekday: "short",
                month: "2-digit",
                day: "numeric",
              };
              $(td).html(start_time.toLocaleTimeString())
            }
          }
        },
        {
          "bVisible": false,
          "aTargets": [3]
        }
      ],
      "rowGroup": {
        "dataSrc": 3
      },
    });
  });
</script>

<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#home">Completed Games</a></li>
  <li><a data-toggle="tab" href="#menu1">Upcoming Games</a></li>
</ul>

<div class="tab-content">
  <div id="home" class="tab-pane fade in active">
    <table id="game-list-new" class="table table-striped table-bordered table-compact">
      <thead id="game-list-new-header"/>
      <thead/>
      <tbody>
        {% for game in finished_games %}
        <tr>
          <td align="right" width="30%"><a href="/team/{{ game.home_team.id }}">{{ game.home_team.name }}</a></td>
          <td align="left" width="30%"><a href="/team/{{ game.away_team.id }}">{{ game.away_team.name }}</a></td>
          <td align="center" class="start_time" width="20%">{{ game.start_time }}</td>
          <td align="center" width="20%">
            <div class="modal fade" id="gameModal{{ game.id }}" tabindex="-1" role="dialog">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">
                      <img src="{{ game.home_team.logo }}" alt="" id="team-logo-game-left" width="30px" height="30px" />{{ game.home_team.name }} - {{ game.away_team.name }}<img src="{{ game.away_team.logo }}" alt="" id="team-logo-game-right" width="30px" height="30px" />
                    </h4>
                    <div class="game-info">{{ game.stadium }}, {{ game.city }}</div>
                    <div class="game-info">Referee: {{ game.referee }}</div>
                    <div class="blur-content blurred-content blur-content{{ game.id }}"><h4 class="modal-title">{{ game.home_team_score }} - {{ game.away_team_score }}</h4></div>
                  </div>
                  <div class="modal-body">
                    <div class="row" id="game-summary">
                      <div class="col-sm-6">
                        Level: {% include 'severity_badge.html' %}
                      </div>
                      <div class="col-sm-6">
                        Overall Score: <div id="game-modal-score">{{ game.interest_score }}</div>
                      </div>
                    </div>
                    <div><h5>Reasons</h5></div>
                    <table class="table table-striped table-bordered table-compact" id="game-score-modifications-table">
                      <thead>
                        <th>Points</th>
                        <th>Priority</th>
                        <th>Description</th>
                      </thead>
                      <tbody>
                        {% for score_modification in game.sorted_score_modifications %}
                          <tr>
                            <td><div class="blur-content blurred-content blur-content{{ game.id }}">{{ score_modification.value }}</div></td>
                            <td><div class="blur-content blurred-content blur-content{{ game.id }}">{{ score_modification.priority }}</div></td>
                            <td><div class="blur-content blurred-content blur-content{{ game.id }}">{{ score_modification.reason }}</div></td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button class="blur-button blur-button{{ game.id }} reveal btn btn-primary" id="blur-toggle-button" onclick="blur_button_click({{ game.id }})">Reveal
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {% include 'severity_badge.html' %}
          </td>
          <td>{{ game.date_from_start_time }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="menu1" class="tab-pane fade">
    <table id="game-list-upcoming" class="table table-striped table-bordered table-compact">
      <thead id="game-list-upcoming-header"/>
      <thead/>
      <tbody>
        {% for game in upcoming_games %}
        <tr>
          <td align="right" width="30%"><a href="/team/{{ game.home_team.id }}">{{ game.home_team.name }}</a></td>
          <td align="left" width="30%"><a href="/team/{{ game.away_team.id }}">{{ game.away_team.name }}</a></td>
          <td align="center" class="start_time" width="20%">{{ game.start_time }}</td>
          <td>{{ game.date_from_start_time }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
